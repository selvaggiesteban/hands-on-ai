# Event-Driven Architecture Schema
# Event catalog and configuration

event_driven_architecture:
  pattern: "event_sourcing"
  description: "Event-driven architecture with event sourcing and CQRS"

  # Event Catalog
  event_catalog:
    - event: "UserRegistered"
      version: "1.0"
      schema: "./schemas/user-registered.avro"
      description: "Emitted when a new user registers"
      producers:
        - "user-service"
      consumers:
        - "email-service"
        - "analytics-service"
        - "welcome-campaign-service"
      payload:
        user_id: "uuid"
        email: "string"
        name: "string"
        registered_at: "timestamp"
      retry_policy:
        max_attempts: 3
        backoff: "exponential"
      dead_letter_queue:
        enabled: true
        topic: "dlq.user-registered"

    - event: "OrderPlaced"
      version: "1.0"
      schema: "./schemas/order-placed.avro"
      description: "Emitted when customer places an order"
      producers:
        - "order-service"
      consumers:
        - "inventory-service"
        - "payment-service"
        - "shipping-service"
        - "notification-service"
      payload:
        order_id: "uuid"
        user_id: "uuid"
        items: "array"
        total_amount: "decimal"
        placed_at: "timestamp"
      retry_policy:
        max_attempts: 5
        backoff: "exponential"
      compensation_event: "OrderCancelled"

    - event: "PaymentProcessed"
      version: "1.0"
      schema: "./schemas/payment-processed.avro"
      description: "Emitted when payment is successfully processed"
      producers:
        - "payment-service"
      consumers:
        - "order-service"
        - "fulfillment-service"
        - "notification-service"
      payload:
        payment_id: "uuid"
        order_id: "uuid"
        amount: "decimal"
        payment_method: "string"
        processed_at: "timestamp"

    - event: "InventoryUpdated"
      version: "1.0"
      schema: "./schemas/inventory-updated.avro"
      description: "Emitted when inventory levels change"
      producers:
        - "inventory-service"
      consumers:
        - "product-service"
        - "analytics-service"
        - "recommendation-service"
      payload:
        product_id: "uuid"
        quantity_change: "integer"
        new_quantity: "integer"
        updated_at: "timestamp"

  # Event Store Configuration
  event_store:
    provider: "EventStore"
    configuration:
      host: "eventstore"
      port: 2113
      username: "${EVENTSTORE_USERNAME}"
      password: "${EVENTSTORE_PASSWORD}"
    retention:
      days: 365
      snapshot_frequency: 100

  # Message Broker
  message_broker:
    provider: "kafka"
    configuration:
      brokers:
        - "kafka-1:9092"
        - "kafka-2:9092"
        - "kafka-3:9092"
      default_partitions: 3
      replication_factor: 2
      retention_hours: 168  # 7 days

  # CQRS Pattern
  cqrs:
    enabled: true
    command_side:
      database: "postgresql"
      consistency: "strong"
    query_side:
      database: "elasticsearch"
      consistency: "eventual"
      refresh_strategy: "event_driven"
    projections:
      - name: "user_profile"
        events: ["UserRegistered", "UserUpdated", "UserDeleted"]
        storage: "elasticsearch"
      - name: "order_history"
        events: ["OrderPlaced", "OrderUpdated", "OrderCancelled"]
        storage: "elasticsearch"
      - name: "inventory_view"
        events: ["InventoryUpdated", "ProductAdded", "ProductRemoved"]
        storage: "redis"

  # Saga Orchestration
  saga:
    pattern: "orchestration"  # or "choreography"
    sagas:
      - name: "order_fulfillment"
        description: "Orchestrates order fulfillment process"
        steps:
          - service: "order-service"
            action: "CreateOrder"
            compensation: "CancelOrder"
          - service: "payment-service"
            action: "ProcessPayment"
            compensation: "RefundPayment"
          - service: "inventory-service"
            action: "ReserveInventory"
            compensation: "ReleaseInventory"
          - service: "shipping-service"
            action: "CreateShipment"
            compensation: "CancelShipment"
        timeout: 300  # 5 minutes

  # Event Schema Registry
  schema_registry:
    provider: "Confluent Schema Registry"
    url: "http://schema-registry:8081"
    compatibility: "BACKWARD"
    auto_register: false

  # Dead Letter Queues
  dead_letter_queues:
    enabled: true
    retention_days: 30
    monitoring:
      alert_threshold: 100
      alert_recipients: ["devops@example.com"]

  # Monitoring and Observability
  observability:
    event_tracking:
      enabled: true
      track_latency: true
      track_throughput: true
    distributed_tracing:
      enabled: true
      provider: "Jaeger"
      sample_rate: 0.1
    metrics:
      - name: "events_published"
        type: "counter"
      - name: "events_consumed"
        type: "counter"
      - name: "event_processing_duration"
        type: "histogram"
      - name: "dlq_messages"
        type: "gauge"
