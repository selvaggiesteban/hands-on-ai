# Threat Model - Security Planning Schema
# STRIDE Analysis and OWASP Top 10 Mapping

threat_model:
  project_name: "[PROJECT_NAME]"
  version: "1.0.1"
  schema_version: "1.0"
  last_updated: "2025-01-14"

  # STRIDE Analysis
  stride_analysis:
    - category: "Spoofing"
      threats:
        - "Unauthorized users impersonating legitimate users"
        - "API requests without proper authentication"
      controls:
        - "JWT with RS256 algorithm"
        - "Multi-factor authentication (MFA) optional"
        - "Session management with secure tokens"
      residual_risk: "low"

    - category: "Tampering"
      threats:
        - "Malicious modification of data in transit"
        - "SQL injection attacks"
      controls:
        - "HTTPS/TLS 1.3 for all communications"
        - "Parameterized queries for database operations"
        - "Input validation on all endpoints"
      residual_risk: "low"

    - category: "Repudiation"
      threats:
        - "Users denying actions they performed"
      controls:
        - "Comprehensive audit logging"
        - "Immutable log storage"
        - "Timestamp and user tracking"
      residual_risk: "low"

    - category: "Information Disclosure"
      threats:
        - "Sensitive data exposure through API responses"
        - "Error messages revealing system information"
      controls:
        - "Data classification and encryption"
        - "Generic error messages"
        - "API response filtering"
      residual_risk: "medium"

    - category: "Denial of Service"
      threats:
        - "API flooding attacks"
        - "Resource exhaustion"
      controls:
        - "Rate limiting (100 req/15min)"
        - "Request throttling"
        - "Circuit breakers"
      residual_risk: "medium"

    - category: "Elevation of Privilege"
      threats:
        - "Users accessing unauthorized resources"
        - "Privilege escalation attacks"
      controls:
        - "Role-based access control (RBAC)"
        - "Principle of least privilege"
        - "Regular permission audits"
      residual_risk: "low"

  # OWASP Top 10 Mapping
  owasp_top10_mapping:
    A01_broken_access_control:
      status: "mitigated"
      controls:
        - "RBAC implementation"
        - "Attribute-based access policies"
        - "Authorization middleware on all protected routes"
      tests:
        - "skills/tests/security/rbac_test.py"
        - "skills/tests/security/auth_bypass_test.py"

    A02_cryptographic_failures:
      status: "mitigated"
      controls:
        - "TLS 1.3 for data in transit"
        - "AES-256 for data at rest"
        - "bcrypt for password hashing"
      tests:
        - "skills/tests/security/crypto_test.py"

    A03_injection:
      status: "mitigated"
      controls:
        - "Parameterized queries (prepared statements)"
        - "Input validation with Joi"
        - "Output encoding"
        - "ORM/Query Builder usage"
      tests:
        - "skills/tests/security/injection_test.py"

    A04_insecure_design:
      status: "in_progress"
      controls:
        - "Threat modeling during design phase"
        - "Security requirements in user stories"
        - "Security review before implementation"

    A05_security_misconfiguration:
      status: "mitigated"
      controls:
        - "Security headers via Helmet.js"
        - "Disable unnecessary features"
        - "Regular dependency updates"
        - "Secure default configurations"

    A06_vulnerable_components:
      status: "monitored"
      controls:
        - "Snyk vulnerability scanning"
        - "Automated dependency updates"
        - "Software Bill of Materials (SBOM)"
      tests:
        - "npm audit"
        - "snyk test"

    A07_identification_authentication_failures:
      status: "mitigated"
      controls:
        - "JWT with 1h expiry"
        - "Refresh token mechanism"
        - "Password complexity requirements"
        - "Account lockout after failed attempts"

    A08_software_data_integrity_failures:
      status: "in_progress"
      controls:
        - "Digital signatures for critical data"
        - "Integrity checks"
        - "Secure CI/CD pipeline"

    A09_security_logging_monitoring_failures:
      status: "mitigated"
      controls:
        - "Comprehensive logging with Winston"
        - "Security event monitoring"
        - "Automated alerts for suspicious activity"
      tests:
        - "skills/tests/security/logging_test.py"

    A10_server_side_request_forgery:
      status: "mitigated"
      controls:
        - "URL whitelist for external requests"
        - "Network segmentation"
        - "Input validation for URLs"

  # Secrets Management
  secrets_scan:
    enabled: true
    tools:
      - "trufflehog"
      - "gitleaks"
    pre_commit: true
    exclusions:
      - "*.example"
      - "*.template"

  # Compliance Requirements
  compliance:
    gdpr:
      applicable: true
      requirements:
        - "Data minimization"
        - "Right to be forgotten"
        - "Data portability"
        - "Privacy by design"

    hipaa:
      applicable: false

    pci_dss:
      applicable: false

    sox:
      applicable: false

  # Security Testing
  security_testing:
    static_analysis:
      tools: ["eslint-plugin-security", "semgrep"]
      frequency: "on_commit"

    dynamic_analysis:
      tools: ["OWASP ZAP", "Burp Suite"]
      frequency: "weekly"

    penetration_testing:
      frequency: "quarterly"
      scope: "full_application"

  # Incident Response
  incident_response:
    contact:
      security_lead: "security@example.com"
      escalation: "cto@example.com"

    procedures:
      - "Identify and contain"
      - "Assess impact"
      - "Notify stakeholders"
      - "Remediate vulnerability"
      - "Post-incident review"

  # Web Events Security Controls
  # Reference: knowledge_base/technologies/frontend/web-events/
  web_events_security:

    mouse_keyboard_events:
      threats:
        - "XSS via event handler injection"
        - "Clickjacking attacks"
        - "Keylogger attempts"
      controls:
        - "Content Security Policy (CSP) headers"
        - "X-Frame-Options: DENY"
        - "Sanitize all event handler attributes"
        - "No eval() in event handlers"
      validation_checklist: "knowledge_base/technologies/frontend/web-events/README.md"

    form_events:
      threats:
        - "SQL injection via form inputs"
        - "XSS in form fields"
        - "CSRF on form submissions"
        - "Mass assignment vulnerabilities"
      controls:
        - "CRITICAL: Server-side validation always required"
        - "Client-side validation for UX only"
        - "CSRF tokens on all POST/PUT/DELETE"
        - "Input sanitization with DOMPurify"
        - "Password hashing with bcrypt (cost factor 12)"
        - "Rate limiting: 5 attempts per 15 minutes"
      validation_checklist: "knowledge_base/technologies/frontend/web-events/README.md#form-events"

    file_upload_events:
      threats:
        - "Malware upload"
        - "Path traversal attacks"
        - "DoS via large files"
        - "Double extension exploits"
      controls:
        - "MIME type validation (server-side)"
        - "File extension whitelist"
        - "Virus scanning on upload"
        - "Size limits enforced (5MB images, 50MB videos)"
        - "Rename files to UUID"
        - "Store outside webroot"
        - "No execution permissions on upload directory"
      validation_checklist: "knowledge_base/technologies/frontend/web-events/data-ui-best-practices.md#file-upload"

    clipboard_events:
      threats:
        - "XSS via pasted content"
        - "Sensitive data exposure"
        - "Clipboard hijacking"
      controls:
        - "Sanitize pasted HTML content"
        - "Strip scripts from clipboard data"
        - "Prevent copying sensitive data (passwords, tokens)"
        - "No clipboard access on sensitive pages"
      validation_checklist: "knowledge_base/technologies/frontend/web-events/README.md#clipboard"

    drag_drop_events:
      threats:
        - "File injection attacks"
        - "Path traversal"
        - "XSS via dropped content"
      controls:
        - "Validate dropped file types"
        - "Same security as file upload"
        - "Sanitize file names"
        - "Prevent directory drops"
      validation_checklist: "knowledge_base/technologies/frontend/web-events/README.md#drag-drop"

    authentication_events:
      threats:
        - "Brute force attacks"
        - "Session hijacking"
        - "Credential stuffing"
        - "Insecure password storage"
      controls:
        - "CRITICAL: bcrypt/argon2 for passwords (NEVER MD5/SHA1)"
        - "JWT with RS256 algorithm"
        - "HttpOnly, Secure, SameSite=Strict cookies"
        - "Rate limiting: 5 attempts per 15min, then account lockout"
        - "Session timeout: 1 hour idle, 24 hours absolute"
        - "2FA support (TOTP, SMS)"
        - "Refresh token rotation"
        - "Audit logging for all auth events"
      validation_checklist: "knowledge_base/technologies/frontend/web-events/media-and-advanced.md#authentication"

    ecommerce_events:
      threats:
        - "Payment data theft"
        - "Cart manipulation"
        - "Price tampering"
        - "Order fraud"
      controls:
        - "CRITICAL: PCI DSS compliance required"
        - "NEVER store raw credit card numbers"
        - "Use payment gateway tokenization (Stripe, PayPal)"
        - "HTTPS enforcement (HSTS headers)"
        - "Server-side price calculation (don't trust client)"
        - "CSRF tokens on checkout"
        - "Rate limiting on checkout endpoints"
        - "Fraud detection integration"
        - "3D Secure authentication"
      validation_checklist: "knowledge_base/technologies/frontend/web-events/ecommerce-and-social.md#ecommerce"

    chat_messaging_events:
      threats:
        - "XSS in messages"
        - "Message injection"
        - "Privacy violations"
        - "Spam/phishing"
      controls:
        - "Sanitize message HTML"
        - "End-to-end encryption (recommended)"
        - "Rate limiting: 10 messages per minute"
        - "Blocked users enforcement"
        - "Report/moderation system"
        - "No script execution in messages"
      validation_checklist: "knowledge_base/technologies/frontend/web-events/ecommerce-and-social.md#chat"

    media_events:
      threats:
        - "DRM bypass"
        - "Hotlinking"
        - "Unauthorized distribution"
      controls:
        - "Signed URLs with expiration"
        - "Referer checking"
        - "DRM implementation (if required)"
        - "Watermarking (if applicable)"
      validation_checklist: "knowledge_base/technologies/frontend/web-events/media-and-advanced.md#media"

    api_events:
      threats:
        - "API abuse"
        - "Data scraping"
        - "Unauthorized access"
      controls:
        - "API authentication (JWT)"
        - "Rate limiting per endpoint"
        - "CORS whitelist"
        - "Input validation on all endpoints"
        - "Output encoding"
        - "API versioning"
      validation_checklist: "knowledge_base/technologies/frontend/web-events/data-ui-best-practices.md#security"

  # Required Security Headers
  security_headers:
    required:
      - header: "Content-Security-Policy"
        value: "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline'"
        purpose: "Prevent XSS attacks"

      - header: "X-Content-Type-Options"
        value: "nosniff"
        purpose: "Prevent MIME type sniffing"

      - header: "X-Frame-Options"
        value: "DENY"
        purpose: "Prevent clickjacking"

      - header: "X-XSS-Protection"
        value: "1; mode=block"
        purpose: "Enable XSS filter"

      - header: "Strict-Transport-Security"
        value: "max-age=31536000; includeSubDomains"
        purpose: "Force HTTPS"

      - header: "Referrer-Policy"
        value: "strict-origin-when-cross-origin"
        purpose: "Control referrer information"

      - header: "Permissions-Policy"
        value: "geolocation=(), microphone=(), camera=()"
        purpose: "Control browser features"

  # Event Handler Security Rules
  event_handler_rules:
    prohibited:
      - "eval() with user input"
      - "Function() constructor with user input"
      - "innerHTML with unsanitized data"
      - "document.write() in production"
      - "setTimeout/setInterval with string argument"
      - "onclick='...' inline handlers (use addEventListener)"

    required:
      - "Use addEventListener for event binding"
      - "Remove event listeners on component unmount"
      - "Sanitize all user input before display"
      - "Validate on both client and server"
      - "Debounce frequent events (input, resize, scroll)"
      - "Use passive listeners for scroll/touch"

  # Validation Tools
  automated_validation:
    web_events_checklist:
      enabled: true
      reference: "knowledge_base/technologies/frontend/web-events/"
      prompts: "src/project_meta/ai-context/prompt-library.json"
      validators:
        - "web_events_validation"
        - "ecommerce_validation"
        - "accessibility_audit"
        - "security_events_audit"
        - "performance_validation"
